<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seduhin POS System</title>
    <style>
        :root { --primary: #6c5ce7; --dark: #2d3436; --light: #f5f6fa; --danger: #e74c3c; --success: #00b894; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--light); color: var(--dark); }
        
        /* Layout */
        .app-container { display: flex; height: 100vh; }
        .sidebar { width: 250px; background: white; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .content { flex-grow: 1; padding: 30px; overflow-y: auto; }
        
        /* Components */
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        
        /* Login Screen */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); display: flex; justify-content: center; align-items: center; z-index: 999; }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        
        /* Menu Grid (Kasir) */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: 0.2s; display: flex; flex-direction: column; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        
        /* PERBAIKAN GAMBAR DI KASIR */
        .card-img { height: 160px; width: 100%; overflow: hidden; background: #eee; }
        .card-img img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        .card:hover .card-img img { transform: scale(1.05); }
        
        .card-body { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
        .card h4 { margin: 0 0 5px 0; font-size: 1.1rem; color: #2d3436; }
        .price { color: var(--primary); font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; }
        .stock-badge { font-size: 0.8rem; background: #dfe6e9; padding: 2px 8px; border-radius: 4px; color: #636e72; display: inline-block; margin-bottom: 10px; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; vertical-align: middle; }
        th { background: #f8f9fa; font-weight: 700; color: #2d3436; }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; color: white; font-weight: 600; }
        .bg-pending { background: #f1c40f; color: #333; }
        .bg-paid { background: var(--success); }
        .bg-cancel { background: var(--danger); }
        
        /* PERBAIKAN GAMBAR DI TABEL */
        .thumb-img { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; border: 1px solid #eee; }

        /* Navigation */
        .nav-link { display: block; padding: 12px; margin: 5px 0; color: #636e72; text-decoration: none; border-radius: 6px; font-weight: 500; }
        .nav-link:hover, .nav-link.active { background: #eef2ff; color: var(--primary); font-weight: 700; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h1 style="color:var(--primary); margin-bottom:10px;">‚òï Seduhin</h1>
            <p style="color:#666; margin-bottom:20px;">Login Admin / Kasir</p>
            <form onsubmit="handleLogin(event)">
                <input type="email" id="email" placeholder="Email (admin@seduhin.com)" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit" class="btn btn-primary" style="width:100%; margin-top:10px;">MASUK SISTEM</button>
            </form>
        </div>
    </div>

    <div id="app-container" class="app-container hidden">
        <div class="sidebar">
            <h2 style="color:var(--primary); margin-bottom: 30px; padding-left: 10px;">‚òï Seduhin</h2>
            <a href="#" class="nav-link active" onclick="showPage(event, 'pos')">üñ•Ô∏è Kasir</a>
            <a href="#" class="nav-link" onclick="showPage(event, 'history')">üìú Riwayat Transaksi</a>
            <a href="#" class="nav-link" onclick="showPage(event, 'menu-mgr')">üì¶ Kelola Menu</a>
            <div style="flex-grow:1"></div>
            <button onclick="logout()" class="btn btn-danger" style="width:100%">Keluar</button>
        </div>

        <div class="content">
            
            <div id="page-pos">
                <div style="display:grid; grid-template-columns: 3fr 1.2fr; gap: 25px;">
                    <div>
                        <h2 style="margin-top:0">Daftar Menu</h2>
                        <div id="menu-grid" class="menu-grid">
                            <div style="text-align:center; padding:20px;">Loading data...</div>
                        </div>
                    </div>
                    
                    <div style="background:white; padding:25px; border-radius:12px; height:fit-content; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position:sticky; top:20px;">
                        <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:15px;">üõí Keranjang</h3>
                        
                        <div style="margin-bottom:15px;">
                            <label style="font-size:0.9rem; font-weight:600; display:block; margin-bottom:5px;">Nama Pelanggan</label>
                            <input type="text" id="custName" placeholder="Masukkan nama..." style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
                        </div>

                        <div id="cart-items" style="margin-bottom:20px; max-height:350px; overflow-y:auto; min-height:100px;">
                            <p style="color:#999; text-align:center; margin-top:30px;">Keranjang masih kosong</p>
                        </div>

                        <div style="border-top:2px solid #333; padding-top:15px; margin-bottom:20px;">
                            <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.3rem; color:#2d3436;">
                                <span>Total</span>
                                <span id="cart-total">Rp 0</span>
                            </div>
                        </div>
                        
                        <button onclick="checkout()" class="btn btn-success" style="width:100%; padding:12px; font-size:1rem;">BAYAR SEKARANG</button>
                    </div>
                </div>
            </div>

            <div id="page-history" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 style="margin:0;">Riwayat Transaksi</h2>
                    <button onclick="loadOrders()" class="btn btn-primary">üîÑ Refresh Data</button>
                </div>
                <div style="overflow-x:auto;">
                    <table id="history-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tanggal</th>
                                <th>Pelanggan</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th style="text-align:center;">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="history-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="page-menu-mgr" class="hidden">
                <h2 style="margin-top:0;">Manajemen Menu</h2>
                <p style="color:#666; margin-bottom:20px;">Kelola ketersediaan produk.</p>
                <div style="overflow-x:auto;">
                    <table id="mgr-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Foto</th>
                                <th>Nama Produk</th>
                                <th>Harga</th>
                                <th>Stok</th>
                                <th style="text-align:center;">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="mgr-body"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script>
        const API_BASE = '/public';
        let cart = [];
        let allMenus = [];

        // --- AUTH LOGIC ---
        function checkAuth() {
            if(localStorage.getItem('seduhin_token')) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                loadMenus();
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    body: JSON.stringify({email, password})
                });
                const data = await res.json();
                
                if(data.success) {
                    localStorage.setItem('seduhin_token', data.data.token);
                    checkAuth();
                } else {
                    alert("Gagal: " + data.message);
                }
            } catch(err) { alert("Error Login: " + err); }
        }

        function logout() {
            if(confirm('Yakin ingin keluar?')) {
                localStorage.removeItem('seduhin_token');
                location.reload();
            }
        }

        // --- NAVIGATION ---
        function showPage(e, pageId) {
            if(e) e.preventDefault();
            
            // Hide all pages
            document.querySelectorAll('.content > div').forEach(div => div.classList.add('hidden'));
            // Show target page
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            
            // Update Active Link
            document.querySelectorAll('.nav-link').forEach(a => a.classList.remove('active'));
            if(e) e.target.classList.add('active');

            // Load Data Specific
            if(pageId === 'history') loadOrders();
            if(pageId === 'menu-mgr') loadMenuMgr();
        }

        // --- DATA: MENU ---
        async function loadMenus() {
            try {
                const res = await fetch(`${API_BASE}/menus`);
                const json = await res.json();
                allMenus = json.data;
                renderMenuGrid();
            } catch(err) {
                console.error(err);
            }
        }

        function renderMenuGrid() {
            const container = document.getElementById('menu-grid');
            if(allMenus.length === 0) {
                container.innerHTML = "Data menu kosong.";
                return;
            }

            // PERBAIKAN GAMBAR DI SINI:
            // Kita langsung pakai URL dari database (https://...)
            container.innerHTML = allMenus.map(m => `
                <div class="card">
                    <div class="card-img">
                        ${m.foto_produk ? 
                            `<img src="${m.foto_produk}" alt="${m.nama_produk}" onerror="this.src='https://placehold.co/400x300?text=No+Image'">` : 
                            `<span style="font-size:3rem; color:#ccc;">‚òï</span>`}
                    </div>
                    <div class="card-body">
                        <h4>${m.nama_produk}</h4>
                        <div class="price">Rp ${parseInt(m.harga).toLocaleString('id-ID')}</div>
                        <div class="stock-badge">Stok: ${m.stok}</div>
                        <button onclick="addToCart(${m.id})" class="btn btn-primary" style="width:100%; margin-top:auto;" ${m.stok<=0?'disabled style="background:#ccc"':''}>
                            ${m.stok > 0 ? '+ Tambah' : 'Habis'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // --- CART ---
        function addToCart(id) {
            const menu = allMenus.find(m => m.id === id);
            const exist = cart.find(c => c.id === id);
            
            if(exist && exist.qty >= menu.stok) return alert("Stok tidak cukup!");

            if(exist) exist.qty++; 
            else cart.push({id, name:menu.nama_produk, price:menu.harga, qty:1});
            
            renderCart();
        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            let total = 0;
            if(cart.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#999; margin-top:30px;">Keranjang kosong</p>';
            } else {
                container.innerHTML = cart.map((c, i) => {
                    total += c.price * c.qty;
                    return `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px dashed #eee; padding-bottom:10px;">
                        <div>
                            <div style="font-weight:600;">${c.name}</div>
                            <small style="color:#666;">${c.qty} x Rp ${parseInt(c.price).toLocaleString()}</small>
                        </div>
                        <div style="text-align:right">
                            <div style="font-weight:bold;">Rp ${(c.price*c.qty).toLocaleString()}</div>
                            <a href="#" onclick="cart.splice(${i},1);renderCart()" style="color:var(--danger);font-size:0.8rem;text-decoration:none;">&times; Hapus</a>
                        </div>
                    </div>`;
                }).join('');
            }
            document.getElementById('cart-total').innerText = 'Rp ' + total.toLocaleString('id-ID');
        }

        async function checkout() {
            const nama = document.getElementById('custName').value;
            if(!nama) return alert("Mohon isi nama pelanggan!");
            if(cart.length === 0) return alert("Keranjang kosong!");

            const payload = {
                nama_pelanggan: nama,
                items: cart.map(c => ({menu_id: c.id, qty: c.qty}))
            };

            try {
                const res = await fetch(`${API_BASE}/orders`, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const json = await res.json();
                
                if(json.success) {
                    alert("‚úÖ Transaksi Berhasil!");
                    cart = []; renderCart(); document.getElementById('custName').value = '';
                    loadMenus(); // Refresh stok
                } else {
                    alert("Gagal: " + json.message);
                }
            } catch(e) { alert("Error: " + e); }
        }

        // --- HISTORY ---
        async function loadOrders() {
            const res = await fetch(`${API_BASE}/orders`);
            const json = await res.json();
            const tbody = document.getElementById('history-body');
            
            tbody.innerHTML = json.data.map(o => `
                <tr>
                    <td><b>#${o.id}</b></td>
                    <td>${o.created_at ? new Date(o.created_at).toLocaleString('id-ID') : '-'}</td>
                    <td>${o.nama_pelanggan}</td>
                    <td style="font-weight:bold;">Rp ${parseInt(o.total).toLocaleString()}</td>
                    <td><span class="badge bg-${o.status}">${o.status.toUpperCase()}</span></td>
                    <td style="text-align:center;">
                        <button onclick="editStatus(${o.id})" class="btn btn-primary" style="padding:5px 10px; font-size:0.8rem">Edit</button>
                        <button onclick="deleteOrder(${o.id})" class="btn btn-danger" style="padding:5px 10px; font-size:0.8rem">Hapus</button>
                        <a href="${API_BASE}/orders/${o.id}/download" target="_blank" class="btn btn-success" style="padding:5px 10px; font-size:0.8rem; text-decoration:none;">üñ®Ô∏è Struk</a>
                    </td>
                </tr>
            `).join('');
        }

        async function editStatus(id) {
            const newStatus = prompt("Update status (pending / paid / cancel):", "paid");
            if(newStatus) {
                await fetch(`${API_BASE}/orders/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({status: newStatus})
                });
                loadOrders();
            }
        }

        async function deleteOrder(id) {
            if(confirm("Hapus riwayat ini? Data tidak bisa kembali.")) {
                await fetch(`${API_BASE}/orders/${id}`, { method: 'DELETE' });
                loadOrders();
            }
        }

        // --- MENU MANAGER ---
        async function loadMenuMgr() {
            const tbody = document.getElementById('mgr-body');
            
            // PERBAIKAN GAMBAR DI SINI JUGA
            tbody.innerHTML = allMenus.map(m => `
                <tr>
                    <td>${m.id}</td>
                    <td>
                        ${m.foto_produk ? 
                        `<img src="${m.foto_produk}" class="thumb-img" onerror="this.src='https://placehold.co/60'">` : 
                        '-'}
                    </td>
                    <td><b>${m.nama_produk}</b></td>
                    <td>Rp ${parseInt(m.harga).toLocaleString()}</td>
                    <td>${m.stok}</td>
                    <td style="text-align:center;">
                        <button onclick="deleteMenu(${m.id})" class="btn btn-danger" style="padding:5px 10px; font-size:0.8rem">Hapus</button>
                    </td>
                </tr>
            `).join('');
        }

        async function deleteMenu(id) {
            if(confirm("Hapus menu ini permanen?")) {
                await fetch(`${API_BASE}/menus/${id}`, { method: 'DELETE' });
                loadMenus(); loadMenuMgr();
            }
        }

        // Start
        checkAuth();
    </script>
</body>
</html>