<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seduhin POS System</title>
    <style>
        :root { --primary: #6c5ce7; --dark: #2d3436; --light: #f5f6fa; --danger: #e74c3c; --success: #00b894; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--light); color: var(--dark); }
        
        /* Layout */
        .app-container { display: flex; height: 100vh; }
        .sidebar { width: 250px; background: white; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .content { flex-grow: 1; padding: 30px; overflow-y: auto; }
        
        /* Components */
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        
        /* Login Screen */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); display: flex; justify-content: center; align-items: center; z-index: 999; }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        
        /* Menu Grid (Kasir) */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: 0.2s; }
        .card:hover { transform: translateY(-5px); }
        .card-img { height: 140px; background: #eee; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .card-img img { width: 100%; height: 100%; object-fit: cover; }
        .card-body { padding: 15px; }
        .price { color: var(--primary); font-weight: bold; font-size: 1.1rem; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #eee; font-weight: 600; }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; color: white; }
        .bg-pending { background: #f39c12; }
        .bg-paid { background: var(--success); }
        .bg-cancel { background: var(--danger); }

        /* Navigation */
        .nav-link { display: block; padding: 12px; margin: 5px 0; color: #666; text-decoration: none; border-radius: 6px; }
        .nav-link:hover, .nav-link.active { background: var(--light); color: var(--primary); font-weight: bold; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>‚òï Seduhin Login</h2>
            <p>Silakan masuk untuk akses sistem</p>
            <form onsubmit="handleLogin(event)">
                <input type="email" id="email" placeholder="Email (admin@seduhin.com)" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit" class="btn btn-primary" style="width:100%">MASUK</button>
            </form>
        </div>
    </div>

    <div id="app-container" class="app-container hidden">
        <div class="sidebar">
            <h2 style="color:var(--primary); margin-bottom: 30px;">‚òï Seduhin</h2>
            <a href="#" class="nav-link active" onclick="showPage('pos')">üñ•Ô∏è Kasir</a>
            <a href="#" class="nav-link" onclick="showPage('history')">üìú Riwayat Transaksi</a>
            <a href="#" class="nav-link" onclick="showPage('menu-mgr')">üì¶ Kelola Menu</a>
            <div style="flex-grow:1"></div>
            <button onclick="logout()" class="btn btn-danger">Keluar</button>
        </div>

        <div class="content">
            
            <div id="page-pos">
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                    <div>
                        <h2>Daftar Menu</h2>
                        <div id="menu-grid" class="menu-grid">Loading...</div>
                    </div>
                    <div style="background:white; padding:20px; border-radius:10px; height:fit-content;">
                        <h3>üõí Keranjang</h3>
                        <input type="text" id="custName" placeholder="Nama Pelanggan" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:5px;">
                        <div id="cart-items" style="margin-bottom:20px; max-height:300px; overflow-y:auto;">
                            <p style="color:#999; text-align:center">Keranjang kosong</p>
                        </div>
                        <div style="border-top:2px solid #eee; padding-top:10px; display:flex; justify-content:space-between; font-weight:bold; font-size:1.2rem;">
                            <span>Total:</span>
                            <span id="cart-total">Rp 0</span>
                        </div>
                        <button onclick="checkout()" class="btn btn-success" style="width:100%; margin-top:20px;">BAYAR SEKARANG</button>
                    </div>
                </div>
            </div>

            <div id="page-history" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2>Riwayat Transaksi</h2>
                    <button onclick="loadOrders()" class="btn btn-primary">Refresh Data</button>
                </div>
                <table id="history-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tanggal</th>
                            <th>Pelanggan</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="history-body"></tbody>
                </table>
            </div>

            <div id="page-menu-mgr" class="hidden">
                <h2>Manajemen Menu</h2>
                <p>Hapus menu yang tidak tersedia.</p>
                <table id="mgr-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Foto</th>
                            <th>Nama Produk</th>
                            <th>Harga</th>
                            <th>Stok</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="mgr-body"></tbody>
                </table>
            </div>

        </div>
    </div>

    <script>
        const API_BASE = '/public';
        let cart = [];
        let allMenus = [];

        // --- AUTH LOGIC ---
        function checkAuth() {
            if(localStorage.getItem('seduhin_token')) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                loadMenus();
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    body: JSON.stringify({email, password})
                });
                const data = await res.json();
                
                if(data.success) {
                    localStorage.setItem('seduhin_token', data.data.token);
                    checkAuth();
                } else {
                    alert("Gagal: " + data.message);
                }
            } catch(err) { alert("Error Login: " + err); }
        }

        function logout() {
            localStorage.removeItem('seduhin_token');
            location.reload();
        }

        // --- PAGE NAVIGATION ---
        function showPage(pageId) {
            document.querySelectorAll('.content > div').forEach(div => div.classList.add('hidden'));
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            
            // Highlight Menu
            document.querySelectorAll('.nav-link').forEach(a => a.classList.remove('active'));
            event.target.classList.add('active');

            if(pageId === 'history') loadOrders();
            if(pageId === 'menu-mgr') loadMenuMgr();
        }

        // --- DATA LOADING ---
        async function loadMenus() {
            const res = await fetch(`${API_BASE}/menus`);
            const json = await res.json();
            allMenus = json.data;
            renderMenuGrid();
        }

        function renderMenuGrid() {
            const container = document.getElementById('menu-grid');
            container.innerHTML = allMenus.map(m => `
                <div class="card">
                    <div class="card-img">
                        ${m.foto_produk ? 
                            `<img src="/public/images/${m.foto_produk}" alt="${m.nama_produk}">` : 
                            `<span style="font-size:2rem">‚òï</span>`}
                    </div>
                    <div class="card-body">
                        <h4>${m.nama_produk}</h4>
                        <div class="price">Rp ${parseInt(m.harga).toLocaleString()}</div>
                        <small>Stok: ${m.stok}</small>
                        <button onclick="addToCart(${m.id})" class="btn btn-primary" style="width:100%; margin-top:10px; font-size:0.8rem">+ Tambah</button>
                    </div>
                </div>
            `).join('');
        }

        // --- CART LOGIC ---
        function addToCart(id) {
            const menu = allMenus.find(m => m.id === id);
            const exist = cart.find(c => c.id === id);
            if(exist) exist.qty++; else cart.push({id, name:menu.nama_produk, price:menu.harga, qty:1});
            renderCart();
        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            let total = 0;
            if(cart.length === 0) container.innerHTML = '<p style="text-align:center;color:#999">Keranjang kosong</p>';
            else {
                container.innerHTML = cart.map((c, i) => {
                    total += c.price * c.qty;
                    return `<div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px dashed #eee; padding-bottom:5px;">
                        <div><b>${c.name}</b><br><small>${c.qty} x ${c.price}</small></div>
                        <div style="text-align:right">
                            Rp ${(c.price*c.qty).toLocaleString()}<br>
                            <a href="#" onclick="cart.splice(${i},1);renderCart()" style="color:red;font-size:0.8rem">Hapus</a>
                        </div>
                    </div>`;
                }).join('');
            }
            document.getElementById('cart-total').innerText = 'Rp ' + total.toLocaleString();
        }

        async function checkout() {
            const nama = document.getElementById('custName').value;
            if(!nama) return alert("Isi nama pelanggan!");
            if(cart.length === 0) return alert("Keranjang kosong!");

            const payload = {
                nama_pelanggan: nama,
                items: cart.map(c => ({menu_id: c.id, qty: c.qty}))
            };

            const res = await fetch(`${API_BASE}/orders`, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            const json = await res.json();
            
            if(json.success) {
                alert("Transaksi Berhasil!");
                cart = []; renderCart(); document.getElementById('custName').value = '';
                loadMenus(); // Refresh stok
            } else {
                alert("Gagal: " + json.message);
            }
        }

        // --- HISTORY LOGIC ---
        async function loadOrders() {
            const res = await fetch(`${API_BASE}/orders`);
            const json = await res.json();
            const tbody = document.getElementById('history-body');
            
            tbody.innerHTML = json.data.map(o => `
                <tr>
                    <td>#${o.id}</td>
                    <td>${o.created_at || '-'}</td>
                    <td>${o.nama_pelanggan}</td>
                    <td>Rp ${parseInt(o.total).toLocaleString()}</td>
                    <td><span class="badge bg-${o.status}">${o.status}</span></td>
                    <td>
                        <button onclick="editStatus(${o.id})" class="btn btn-primary" style="padding:5px 10px; font-size:0.8rem">Edit</button>
                        <button onclick="deleteOrder(${o.id})" class="btn btn-danger" style="padding:5px 10px; font-size:0.8rem">Hapus</button>
                        <a href="${API_BASE}/orders/${o.id}/download" target="_blank" class="btn btn-success" style="padding:5px 10px; font-size:0.8rem; text-decoration:none">Unduh</a>
                    </td>
                </tr>
            `).join('');
        }

        async function editStatus(id) {
            const newStatus = prompt("Masukkan status baru (pending/paid/cancel):", "paid");
            if(newStatus) {
                await fetch(`${API_BASE}/orders/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({status: newStatus})
                });
                loadOrders();
            }
        }

        async function deleteOrder(id) {
            if(confirm("Yakin hapus history ini?")) {
                await fetch(`${API_BASE}/orders/${id}`, { method: 'DELETE' });
                loadOrders();
            }
        }

        // --- MENU MANAGER LOGIC ---
        async function loadMenuMgr() {
            const tbody = document.getElementById('mgr-body');
            tbody.innerHTML = allMenus.map(m => `
                <tr>
                    <td>${m.id}</td>
                    <td>${m.foto_produk || '-'}</td>
                    <td>${m.nama_produk}</td>
                    <td>${m.harga}</td>
                    <td>${m.stok}</td>
                    <td><button onclick="deleteMenu(${m.id})" class="btn btn-danger" style="padding:5px">Hapus</button></td>
                </tr>
            `).join('');
        }

        async function deleteMenu(id) {
            if(confirm("Hapus menu ini permanen?")) {
                await fetch(`${API_BASE}/menus/${id}`, { method: 'DELETE' });
                loadMenus(); loadMenuMgr();
            }
        }

        // Init
        checkAuth();
    </script>
</body>
</html>