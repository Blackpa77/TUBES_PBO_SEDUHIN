<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seduhin POS System</title>
    <style>
        :root { --primary: #6c5ce7; --dark: #2d3436; --light: #f5f6fa; --danger: #e74c3c; --success: #00b894; --warning: #f1c40f; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--light); color: var(--dark); }
        
        /* Layout */
        .app-container { display: flex; height: 100vh; }
        .sidebar { width: 250px; background: white; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .content { flex-grow: 1; padding: 30px; overflow-y: auto; }
        
        /* Components */
        .btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: #333; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        
        /* Login Screen */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); display: flex; justify-content: center; align-items: center; z-index: 999; }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        
        /* Menu Grid (Kasir) */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: 0.2s; display: flex; flex-direction: column; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .card-img { height: 160px; width: 100%; overflow: hidden; background: #eee; }
        .card-img img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        .card-body { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
        .card h4 { margin: 0 0 5px 0; font-size: 1.1rem; color: #2d3436; }
        .price { color: var(--primary); font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; }
        .stock-badge { font-size: 0.8rem; background: #dfe6e9; padding: 2px 8px; border-radius: 4px; color: #636e72; display: inline-block; margin-bottom: 10px; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; vertical-align: middle; }
        th { background: #f8f9fa; font-weight: 700; color: #2d3436; }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; color: white; font-weight: 600; }
        .bg-pending { background: #f1c40f; color: #333; }
        .bg-paid { background: var(--success); }
        .bg-cancel { background: var(--danger); }
        .thumb-img { width: 50px; height: 50px; object-fit: cover; border-radius: 6px; border: 1px solid #eee; }

        /* Navigation */
        .nav-link { display: block; padding: 12px; margin: 5px 0; color: #636e72; text-decoration: none; border-radius: 6px; font-weight: 500; }
        .nav-link:hover, .nav-link.active { background: #eef2ff; color: var(--primary); font-weight: 700; }
        .hidden { display: none !important; }

        /* MODAL FORM */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-box { background: white; padding: 30px; border-radius: 12px; width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { margin: 0; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-family: inherit; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h1 style="color:var(--primary); margin-bottom:10px;">‚òï Seduhin</h1>
            <p style="color:#666; margin-bottom:20px;">Login Admin / Kasir</p>
            <form onsubmit="handleLogin(event)">
                <input type="email" id="email" placeholder="Email (admin@seduhin.com)" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit" class="btn btn-primary" style="width:100%; margin-top:10px;">MASUK SISTEM</button>
            </form>
        </div>
    </div>

    <div id="app-container" class="app-container hidden">
        <div class="sidebar">
            <h2 style="color:var(--primary); margin-bottom: 30px; padding-left: 10px;">‚òï Seduhin</h2>
            <a href="#" class="nav-link active" onclick="showPage(event, 'pos')">üñ•Ô∏è Kasir</a>
            <a href="#" class="nav-link" onclick="showPage(event, 'history')">üìú Riwayat Transaksi</a>
            <a href="#" class="nav-link" onclick="showPage(event, 'menu-mgr')">üì¶ Kelola Menu</a>
            <div style="flex-grow:1"></div>
            <button onclick="logout()" class="btn btn-danger" style="width:100%">Keluar</button>
        </div>

        <div class="content">
            
            <div id="page-pos">
                <div style="display:grid; grid-template-columns: 3fr 1.2fr; gap: 25px;">
                    <div>
                        <h2 style="margin-top:0">Daftar Menu</h2>
                        <div id="menu-grid" class="menu-grid">Loading data...</div>
                    </div>
                    <div style="background:white; padding:25px; border-radius:12px; height:fit-content; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position:sticky; top:20px;">
                        <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:15px;">üõí Keranjang</h3>
                        <div style="margin-bottom:15px;">
                            <label style="font-size:0.9rem; font-weight:600; display:block; margin-bottom:5px;">Nama Pelanggan</label>
                            <input type="text" id="custName" placeholder="Masukkan nama..." style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
                        </div>
                        <div id="cart-items" style="margin-bottom:20px; max-height:350px; overflow-y:auto; min-height:100px;">
                            <p style="color:#999; text-align:center; margin-top:30px;">Keranjang masih kosong</p>
                        </div>
                        <div style="border-top:2px solid #333; padding-top:15px; margin-bottom:20px;">
                            <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.3rem; color:#2d3436;">
                                <span>Total</span>
                                <span id="cart-total">Rp 0</span>
                            </div>
                        </div>
                        <button onclick="checkout()" class="btn btn-success" style="width:100%; padding:12px; font-size:1rem;">BAYAR SEKARANG</button>
                    </div>
                </div>
            </div>

            <div id="page-history" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 style="margin:0;">Riwayat Transaksi</h2>
                    <button onclick="loadOrders()" class="btn btn-primary">üîÑ Refresh Data</button>
                </div>
                <div style="overflow-x:auto;">
                    <table id="history-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tanggal</th>
                                <th>Pelanggan</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th style="text-align:center;">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="history-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="page-menu-mgr" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 style="margin:0;">Manajemen Menu</h2>
                    <button onclick="openModal('add')" class="btn btn-primary">+ Tambah Menu Baru</button>
                </div>
                <div style="overflow-x:auto;">
                    <table id="mgr-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Foto</th>
                                <th>Nama Produk</th>
                                <th>Harga</th>
                                <th>Stok</th>
                                <th style="text-align:center;">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="mgr-body"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <div id="menu-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <div class="modal-header">
                <h3 id="modal-title">Tambah Menu</h3>
                <button onclick="closeModal()" class="close-btn">&times;</button>
            </div>
            <form onsubmit="saveMenu(event)">
                <input type="hidden" id="menuId">
                <div class="form-group">
                    <label>Nama Produk</label>
                    <input type="text" id="menuName" required>
                </div>
                <div class="form-group">
                    <label>Harga (Rp)</label>
                    <input type="number" id="menuPrice" required>
                </div>
                <div class="form-group">
                    <label>Stok Awal</label>
                    <input type="number" id="menuStock" required>
                </div>
                <div class="form-group">
                    <label>URL Foto (Opsional)</label>
                    <input type="text" id="menuImg" placeholder="https://...">
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">SIMPAN</button>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '/public';
        let cart = [];
        let allMenus = [];

        // --- AUTH ---
        function checkAuth() {
            if(localStorage.getItem('seduhin_token')) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                loadMenus();
            }
        }
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    body: JSON.stringify({email, password})
                });
                const data = await res.json();
                if(data.success) {
                    localStorage.setItem('seduhin_token', data.data.token);
                    checkAuth();
                } else { alert("Gagal: " + data.message); }
            } catch(err) { alert("Error Login: " + err); }
        }
        function logout() {
            if(confirm('Yakin keluar?')) {
                localStorage.removeItem('seduhin_token');
                location.reload();
            }
        }

        // --- NAVIGATION ---
        function showPage(e, pageId) {
            if(e) e.preventDefault();
            document.querySelectorAll('.content > div').forEach(div => div.classList.add('hidden'));
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(a => a.classList.remove('active'));
            if(e) e.target.classList.add('active');
            if(pageId === 'history') loadOrders();
            if(pageId === 'menu-mgr') loadMenuMgr();
        }

        // --- KASIR ---
        async function loadMenus() {
            const res = await fetch(`${API_BASE}/menus`);
            const json = await res.json();
            allMenus = json.data;
            renderMenuGrid();
        }
        function renderMenuGrid() {
            const container = document.getElementById('menu-grid');
            container.innerHTML = allMenus.map(m => `
                <div class="card">
                    <div class="card-img">
                        ${m.foto_produk ? `<img src="${m.foto_produk}" onerror="this.src='https://placehold.co/400'">` : `<span style="font-size:3rem">‚òï</span>`}
                    </div>
                    <div class="card-body">
                        <h4>${m.nama_produk}</h4>
                        <div class="price">Rp ${parseInt(m.harga).toLocaleString()}</div>
                        <div class="stock-badge">Stok: ${m.stok}</div>
                        <button onclick="addToCart(${m.id})" class="btn btn-primary" style="width:100%; margin-top:auto;" ${m.stok<=0?'disabled':''}>
                            ${m.stok>0?'+ Tambah':'Habis'}
                        </button>
                    </div>
                </div>
            `).join('');
        }
        function addToCart(id) {
            const m = allMenus.find(x => x.id === id);
            const c = cart.find(x => x.id === id);
            if(c && c.qty >= m.stok) return alert("Stok habis!");
            if(c) c.qty++; else cart.push({id, name:m.nama_produk, price:m.harga, qty:1});
            renderCart();
        }
        function renderCart() {
            const container = document.getElementById('cart-items');
            let total = 0;
            if(cart.length===0) {
                container.innerHTML='<p style="text-align:center;color:#999">Kosong</p>'; 
                document.getElementById('cart-total').innerText = 'Rp 0';
                return;
            }
            container.innerHTML = cart.map((c,i) => {
                total += c.price*c.qty;
                return `<div style="display:flex;justify-content:space-between;margin-bottom:10px;border-bottom:1px dashed #eee;padding-bottom:5px">
                    <div><b>${c.name}</b><br><small>${c.qty} x ${c.price}</small></div>
                    <div>Rp ${(c.qty*c.price).toLocaleString()} <a href="#" onclick="cart.splice(${i},1);renderCart()" style="color:red;text-decoration:none">&times;</a></div>
                </div>`;
            }).join('');
            document.getElementById('cart-total').innerText = 'Rp ' + total.toLocaleString();
        }
        async function checkout() {
            const nama = document.getElementById('custName').value;
            if(!nama || cart.length===0) return alert("Isi nama & keranjang!");
            const res = await fetch(`${API_BASE}/orders`, {
                method:'POST', body:JSON.stringify({nama_pelanggan:nama, items:cart.map(c=>({menu_id:c.id, qty:c.qty}))})
            });
            const json = await res.json();
            if(json.success) { alert("Sukses!"); cart=[]; renderCart(); loadMenus(); }
            else alert("Gagal: "+json.message);
        }

        // --- HISTORY ---
        async function loadOrders() {
            const res = await fetch(`${API_BASE}/orders`);
            const json = await res.json();
            document.getElementById('history-body').innerHTML = json.data.map(o => `
                <tr>
                    <td>#${o.id}</td>
                    <td>${new Date(o.created_at).toLocaleString()}</td>
                    <td>${o.nama_pelanggan}</td>
                    <td>Rp ${parseInt(o.total).toLocaleString()}</td>
                    <td><span class="badge bg-${o.status}">${o.status}</span></td>
                    <td style="text-align:center">
                        <button onclick="editStatus(${o.id})" class="btn btn-primary">Edit</button>
                        <button onclick="deleteOrder(${o.id})" class="btn btn-danger">Hapus</button>
                        <a href="${API_BASE}/orders/${o.id}/download" target="_blank" class="btn btn-success" style="text-decoration:none">Struk</a>
                    </td>
                </tr>
            `).join('');
        }
        async function editStatus(id) {
            const s = prompt("Status baru (paid/pending/cancel):", "paid");
            if(s) { await fetch(`${API_BASE}/orders/${id}`, { method:'PUT', body:JSON.stringify({status:s})}); loadOrders(); }
        }
        async function deleteOrder(id) {
            if(confirm("Hapus?")) { await fetch(`${API_BASE}/orders/${id}`, { method:'DELETE' }); loadOrders(); }
        }

        // --- MENU MANAGER (CRUD) ---
        async function loadMenuMgr() {
            // Refresh data menu dulu
            const res = await fetch(`${API_BASE}/menus`);
            const json = await res.json();
            allMenus = json.data;
            
            document.getElementById('mgr-body').innerHTML = allMenus.map(m => `
                <tr>
                    <td>${m.id}</td>
                    <td>${m.foto_produk ? `<img src="${m.foto_produk}" class="thumb-img">` : '-'}</td>
                    <td>${m.nama_produk}</td>
                    <td>Rp ${parseInt(m.harga).toLocaleString()}</td>
                    <td>${m.stok}</td>
                    <td style="text-align:center">
                        <button onclick="openModal('edit', ${m.id})" class="btn btn-warning">Edit</button>
                        <button onclick="deleteMenu(${m.id})" class="btn btn-danger">Hapus</button>
                    </td>
                </tr>
            `).join('');
        }

        // Modal Logic
        let editMode = false;
        function openModal(mode, id = null) {
            document.getElementById('menu-modal').classList.remove('hidden');
            editMode = (mode === 'edit');
            document.getElementById('modal-title').innerText = editMode ? "Edit Menu" : "Tambah Menu Baru";
            
            if(editMode && id) {
                const m = allMenus.find(x => x.id === id);
                document.getElementById('menuId').value = m.id;
                document.getElementById('menuName').value = m.nama_produk;
                document.getElementById('menuPrice').value = m.harga;
                document.getElementById('menuStock').value = m.stok;
                document.getElementById('menuImg').value = m.foto_produk || '';
            } else {
                document.getElementById('menuId').value = '';
                document.querySelector('form').reset();
            }
        }

        function closeModal() {
            document.getElementById('menu-modal').classList.add('hidden');
        }

        async function saveMenu(e) {
            e.preventDefault();
            const id = document.getElementById('menuId').value;
            const payload = {
                nama_produk: document.getElementById('menuName').value,
                harga: document.getElementById('menuPrice').value,
                stok: document.getElementById('menuStock').value,
                foto_produk: document.getElementById('menuImg').value, // Belum disimpan di backend sebelumnya, tapi dikirim saja
                id_kategori: 1 // Default
            };

            const url = editMode ? `${API_BASE}/menus/${id}` : `${API_BASE}/menus`;
            const method = editMode ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method: method,
                    body: JSON.stringify(payload)
                });
                const json = await res.json();
                if(res.ok) {
                    alert("Berhasil disimpan!");
                    closeModal();
                    loadMenuMgr(); // Refresh tabel
                } else {
                    alert("Gagal: " + json.message);
                }
            } catch(err) { alert("Error: " + err); }
        }

        async function deleteMenu(id) {
            if(confirm("Hapus permanen?")) {
                await fetch(`${API_BASE}/menus/${id}`, { method:'DELETE' });
                loadMenuMgr();
            }
        }

        checkAuth();
    </script>
</body>
</html>